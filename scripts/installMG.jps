jpsType: update
id: magento-install-addon
name: Magento Installation addon
description: This package for magento installation

globals:
  MG_ADMIN_PASS: "${settings.mg_admin_pass}"
  DB_HOST: "${settings.db_host}"
  DB_NAME: magento_${fn.random}
  DB_USER: "${settings.db_user}"
  DB_PASS: "${settings.db_pass}"
  USER_EMAIL: "${settings.user_email}"
  MG_URL: "${settings.mg_url}"

onInstall:
  - installMG
  - setupMG
  - if ("${nodes.cp.master.nodeType}" == "litespeedphp"): setupMGForLS
  - if ("${nodes.cp.master.nodeType}" == "nginxphp"): setupMGForNG
  - install: ${baseUrl}/cachePurge.jps

actions:
  installMG:
    - cmd[${nodes.cp.master.id}]: |-
        wget ${baseUrl}/installMG.sh?_r=${fn.random} -O ~/installMG.sh &>> /var/log/run.log
        wget ${baseUrl}/setupMG.sh?_r=${fn.random} -O ~/setupMG.sh &>> /var/log/run.log
        bash ~/installMG.sh ${globals.DB_USER} ${globals.DB_PASS} ${globals.DB_HOST} ${globals.DB_NAME} ${globals.MG_ADMIN_PASS} ${globals.MG_URL} ${globals.USER_EMAIL} &>> /var/log/run.log
  
  setupMGForLS:
    - cmd[${nodes.cp.master.id}]: |-
        bash ~/setupMG.sh --litemage true &>> /var/log/run.log

  setupMGForNG:
    - cmd[${nodes.cp.master.id}]: |-
        bash ~/setupMG.sh --varnish true &>> /var/log/run.log

  setupMG:
    - cmd[${nodes.cp.master.id}]: |-
        bash ~/setupMG.sh --pgcache true &>> /var/log/run.log
